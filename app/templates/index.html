<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KnowledgeTree</title>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <div class="header-toolbar header-toolbar--space-between">
                <h1 class="card__title">KnowledgeTree - Documentation & Knowledge Base</h1>
                {% if user.permission_level == 'admin' %}
                <a href="{{ url_for('admin_settings') }}">
                    <button class="btn">
                        <span class="btn__label">‚öôÔ∏è Admin Settings</span>
                    </button>
                </a>
                {% endif %}
            </div>
        </div>
        <div class="card__body">
            <p class="u-mb-3">Browse and search organizational knowledge, documentation, and technical resources.</p>
            <p>Welcome, <strong>{{ user.name }}</strong> ({{ user.permission_level }})</p>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <div class="header-toolbar">
                {% if current_path %}
                    <a href="{{ url_for('browse', path=parent_path) }}">
                        <button class="btn">
                            <span class="btn__label">‚Üê Back</span>
                        </button>
                    </a>
                {% endif %}

                <div class="breadcrumb">
                    <strong>Path:</strong>
                    <span class="breadcrumb__separator"></span>
                    <a href="{{ url_for('browse', path='') }}" class="breadcrumb__link">root</a>
                    {% for name in breadcrumb_names[1:] %}
                        {% set path_slice = breadcrumb_names[1:loop.index+1] %}
                        <span class="breadcrumb__separator">/</span>
                        <a href="{{ url_for('browse', path=(path_slice | map('quote_plus') | join('/'))) }}" class="breadcrumb__link">{{ name }}</a>
                    {% endfor %}
                </div>

                <input type="search" id="search-input" placeholder="Search..." class="form-group__input"
                       autocomplete="off" data-start-node="{{ current_node_id }}">
            </div>
        </div>
    </div>

    <div class="card" id="file-browser-container">
        <div class="card__body">
            <div id="file-browser" class="file-browser">
                {% for item in items %}
                    <div class="file-item {% if item.read_only %}file-item--read-only{% endif %}"
                         data-name="{{ item.name }}"
                         data-id="{{ item.id }}"
                         data-is-folder="{{ item.is_folder|lower }}">
                        {% if item.is_folder %}
                            {% if item.is_attached %}
                                <span class="file-item__icon">üìé</span>
                            {% else %}
                                <span class="file-item__icon">üìÅ</span>
                            {% endif %}
                        {% else %}
                            <span class="file-item__icon">üìÑ</span>
                        {% endif %}
                        <span class="file-item__name">{{ item.name }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="context-menu" class="context-menu">
        <ul class="context-menu__list">
            <li id="context-open" class="context-menu__item">Open</li>
            <li id="context-rename" class="context-menu__item">Rename</li>
            <li id="context-delete" class="context-menu__item">Delete</li>
            <hr class="context-menu__separator">
            <li id="context-new-folder" class="context-menu__item">New Folder</li>
            <li id="context-new-attached" class="context-menu__item">New Attached Folder</li>
            <li id="context-new-article" class="context-menu__item">New Article</li>
        </ul>
    </div>

    <div id="search-results" class="dropdown"></div>

    <script>
        const CURRENT_PATH = "{{ current_path }}";
        const CURRENT_NODE_ID = "{{ current_node_id }}";

        // File browser interactions
        const fileBrowser = document.getElementById('file-browser');
        const contextMenu = document.getElementById('context-menu');
        let selectedItemId = null;

        if (fileBrowser) {
            fileBrowser.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('dblclick', () => {
                    const isFolder = item.dataset.isFolder === 'true';
                    const id = item.dataset.id;
                    const name = item.dataset.name;

                    if (isFolder) {
                        const newPath = CURRENT_PATH ? `${CURRENT_PATH}/${encodeURIComponent(name)}` : encodeURIComponent(name);
                        window.location.href = `{{ url_for('browse', path='') }}${newPath}`;
                    } else {
                        window.location.href = `{{ url_for('view_node', node_id='') }}${id}`;
                    }
                });
            });
        }

        // Context menu
        document.getElementById('file-browser-container').addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const targetItem = e.target.closest('.file-item');

            if (targetItem) {
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('file-item--selected'));
                targetItem.classList.add('file-item--selected');
                selectedItemId = targetItem.dataset.id;
            } else {
                selectedItemId = null;
            }

            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
        });

        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
        });

        // Context menu actions
        async function createNewItem(isFolder, isAttached = false) {
            const type = isAttached ? 'attached folder' : (isFolder ? 'folder' : 'article');
            const name = prompt(`Enter name for new ${type}:`);
            if (name) {
                const response = await fetch('{{ url_for("create_node") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        name,
                        parent_id: CURRENT_NODE_ID,
                        is_folder: isFolder,
                        is_attached: isAttached
                    })
                });
                if (response.ok) {
                    const result = await response.json();
                    if (!isFolder) {
                        window.location.href = `{{ url_for('view_node', node_id='') }}${result.id}`;
                    } else {
                        window.location.reload();
                    }
                }
            }
        }

        document.getElementById('context-new-folder').addEventListener('click', () => createNewItem(true, false));
        document.getElementById('context-new-attached').addEventListener('click', () => createNewItem(true, true));
        document.getElementById('context-new-article').addEventListener('click', () => createNewItem(false, false));

        document.getElementById('context-rename').addEventListener('click', async () => {
            if (!selectedItemId) return;
            const currentName = document.querySelector(`.file-item[data-id="${selectedItemId}"]`).dataset.name;
            const newName = prompt("Enter new name:", currentName);
            if (newName && newName !== currentName) {
                await fetch(`{{ url_for('update_node', node_id='') }}${selectedItemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ name: newName })
                });
                window.location.reload();
            }
        });

        document.getElementById('context-delete').addEventListener('click', async () => {
            if (!selectedItemId) return;
            if (confirm("Are you sure you want to delete this item and all its contents?")) {
                await fetch(`{{ url_for('delete_node', node_id='') }}${selectedItemId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                window.location.reload();
            }
        });

        document.getElementById('context-open').addEventListener('click', () => {
            if (selectedItemId) {
                const itemElement = document.querySelector(`.file-item[data-id="${selectedItemId}"]`);
                if(itemElement) itemElement.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
            }
        });

        // Search functionality
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        let searchDebounceTimer;

        searchInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(async () => {
                const query = searchInput.value.trim();
                if (query.length < 2) {
                    searchResults.classList.remove('dropdown--visible');
                    return;
                }

                const response = await fetch(`{{ url_for('search_nodes') }}?query=${encodeURIComponent(query)}&start_node_id=${CURRENT_NODE_ID}`, {
                    credentials: 'same-origin'
                });
                const items = await response.json();

                searchResults.innerHTML = '';
                if (items.length === 0) {
                    searchResults.innerHTML = '<div class="dropdown__empty">No results found.</div>';
                } else {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'dropdown__item';
                        div.innerHTML = `<div class="dropdown__item-title">${item.name}</div><div class="dropdown__item-subtitle">${item.folder_path}</div>`;
                        div.addEventListener('click', () => {
                            if (item.is_folder) {
                                window.location.href = `{{ url_for('browse', path='') }}${item.folder_path}`;
                            } else {
                                window.location.href = `{{ url_for('view_node', node_id='') }}${item.id}`;
                            }
                        });
                        searchResults.appendChild(div);
                    });
                }

                const rect = searchInput.getBoundingClientRect();
                searchResults.style.top = `${rect.bottom + window.scrollY}px`;
                searchResults.style.left = `${rect.left + window.scrollX}px`;
                searchResults.style.width = `${rect.width}px`;
                searchResults.classList.add('dropdown--visible');
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!searchResults.contains(e.target) && e.target !== searchInput) {
                searchResults.classList.remove('dropdown--visible');
            }
        });
    </script>
</body>
</html>
