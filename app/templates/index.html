<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KnowledgeTree</title>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 class="card__title">KnowledgeTree</h1>
                {% if user.permission_level == 'admin' %}
                <a href="{{ url_for('admin_settings') }}">
                    <button class="btn">
                        <span class="btn__label">‚öôÔ∏è Admin Settings</span>
                    </button>
                </a>
                {% endif %}
            </div>
        </div>
        <div class="card__body">
            <p>Welcome, <strong>{{ user.name }}</strong> ({{ user.permission_level }})</p>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                {% if current_path %}
                    <a href="{{ url_for('browse', path=parent_path) }}">
                        <button class="btn">
                            <span class="btn__label">‚Üê Back</span>
                        </button>
                    </a>
                {% endif %}

                <div style="flex-grow: 1;">
                    <strong>Path:</strong>
                    <a href="{{ url_for('browse', path='') }}">root</a>
                    {% for name in breadcrumb_names[1:] %}
                        {% set path_slice = breadcrumb_names[1:loop.index+1] %}
                        / <a href="{{ url_for('browse', path=(path_slice | map('quote_plus') | join('/'))) }}">{{ name }}</a>
                    {% endfor %}
                </div>

                <input type="search" id="search-input" placeholder="Search..."
                       autocomplete="off" data-start-node="{{ current_node_id }}"
                       style="padding: 0.5rem; border: 1px solid #dee2e6; border-radius: 4px; width: 250px;">
            </div>
        </div>
    </div>

    <div class="card" id="file-browser-container">
        <div class="card__body">
            <div id="file-browser" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1.5rem; padding: 1rem;">
                {% for item in items %}
                    <div class="file-item {% if item.read_only %}read-only{% endif %}"
                         data-name="{{ item.name }}"
                         data-id="{{ item.id }}"
                         data-is-folder="{{ item.is_folder|lower }}"
                         style="display: flex; flex-direction: column; align-items: center; text-align: center; padding: 1rem; border-radius: 8px; cursor: pointer; border: 2px solid transparent;">
                        {% if item.is_folder %}
                            {% if item.is_attached %}
                                <span style="font-size: 48px;">üìé</span>
                            {% else %}
                                <span style="font-size: 48px;">üìÅ</span>
                            {% endif %}
                        {% else %}
                            <span style="font-size: 48px;">üìÑ</span>
                        {% endif %}
                        <span class="name" style="word-break: break-all; font-size: 0.9rem; margin-top: 0.5rem;">{{ item.name }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="context-menu" style="display: none; position: absolute; background: white; border: 1px solid #dee2e6; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 8px 0; z-index: 1000;">
        <ul style="list-style: none; margin: 0; padding: 0;">
            <li id="context-open" style="padding: 10px 20px; cursor: pointer;">Open</li>
            <li id="context-rename" style="padding: 10px 20px; cursor: pointer;">Rename</li>
            <li id="context-delete" style="padding: 10px 20px; cursor: pointer;">Delete</li>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #dee2e6;">
            <li id="context-new-folder" style="padding: 10px 20px; cursor: pointer;">New Folder</li>
            <li id="context-new-attached" style="padding: 10px 20px; cursor: pointer;">New Attached Folder</li>
            <li id="context-new-article" style="padding: 10px 20px; cursor: pointer;">New Article</li>
        </ul>
    </div>

    <div id="search-results" style="display: none; position: absolute; background: white; border: 1px solid #dee2e6; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1001; max-height: 400px; overflow-y: auto;"></div>

    <script>
        const CURRENT_PATH = "{{ current_path }}";
        const CURRENT_NODE_ID = "{{ current_node_id }}";

        // File browser interactions
        const fileBrowser = document.getElementById('file-browser');
        const contextMenu = document.getElementById('context-menu');
        let selectedItemId = null;

        if (fileBrowser) {
            fileBrowser.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('dblclick', () => {
                    const isFolder = item.dataset.isFolder === 'true';
                    const id = item.dataset.id;
                    const name = item.dataset.name;

                    if (isFolder) {
                        const newPath = CURRENT_PATH ? `${CURRENT_PATH}/${encodeURIComponent(name)}` : encodeURIComponent(name);
                        window.location.href = `{{ url_for('browse', path='') }}${newPath}`;
                    } else {
                        window.location.href = `{{ url_for('view_node', node_id='') }}${id}`;
                    }
                });
            });
        }

        // Context menu
        document.getElementById('file-browser-container').addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const targetItem = e.target.closest('.file-item');

            if (targetItem) {
                document.querySelectorAll('.file-item').forEach(el => el.style.backgroundColor = '');
                targetItem.style.backgroundColor = '#e9ecef';
                selectedItemId = targetItem.dataset.id;
            } else {
                selectedItemId = null;
            }

            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
        });

        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
        });

        // Context menu actions
        async function createNewItem(isFolder, isAttached = false) {
            const type = isAttached ? 'attached folder' : (isFolder ? 'folder' : 'article');
            const name = prompt(`Enter name for new ${type}:`);
            if (name) {
                const response = await fetch('{{ url_for("create_node") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        name,
                        parent_id: CURRENT_NODE_ID,
                        is_folder: isFolder,
                        is_attached: isAttached
                    })
                });
                if (response.ok) {
                    const result = await response.json();
                    if (!isFolder) {
                        window.location.href = `{{ url_for('view_node', node_id='') }}${result.id}`;
                    } else {
                        window.location.reload();
                    }
                }
            }
        }

        document.getElementById('context-new-folder').addEventListener('click', () => createNewItem(true, false));
        document.getElementById('context-new-attached').addEventListener('click', () => createNewItem(true, true));
        document.getElementById('context-new-article').addEventListener('click', () => createNewItem(false, false));

        document.getElementById('context-rename').addEventListener('click', async () => {
            if (!selectedItemId) return;
            const currentName = document.querySelector(`.file-item[data-id="${selectedItemId}"]`).dataset.name;
            const newName = prompt("Enter new name:", currentName);
            if (newName && newName !== currentName) {
                await fetch(`{{ url_for('update_node', node_id='') }}${selectedItemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ name: newName })
                });
                window.location.reload();
            }
        });

        document.getElementById('context-delete').addEventListener('click', async () => {
            if (!selectedItemId) return;
            if (confirm("Are you sure you want to delete this item and all its contents?")) {
                await fetch(`{{ url_for('delete_node', node_id='') }}${selectedItemId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                window.location.reload();
            }
        });

        document.getElementById('context-open').addEventListener('click', () => {
            if (selectedItemId) {
                const itemElement = document.querySelector(`.file-item[data-id="${selectedItemId}"]`);
                if(itemElement) itemElement.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
            }
        });

        // Search functionality
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        let searchDebounceTimer;

        searchInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(async () => {
                const query = searchInput.value.trim();
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }

                const searchUrl = `{{ url_for('search_nodes') }}?query=${encodeURIComponent(query)}&start_node_id=${CURRENT_NODE_ID}`;
                console.log('Search URL:', searchUrl);

                try {
                    const response = await fetch(searchUrl, {
                        credentials: 'same-origin'
                    });
                    console.log('Search response status:', response.status);

                    if (!response.ok) {
                        console.error('Search failed:', response.status, await response.text());
                        searchResults.innerHTML = '<div style="padding: 10px;">Search error. Check console.</div>';
                        searchResults.style.display = 'block';
                        return;
                    }

                    const items = await response.json();
                    console.log('Search results:', items.length, 'items');

                    searchResults.innerHTML = '';
                    if (items.length === 0) {
                        searchResults.innerHTML = '<div style="padding: 10px;">No results found.</div>';
                    } else {
                        items.forEach(item => {
                            const div = document.createElement('div');
                            div.style.cssText = 'padding: 10px; cursor: pointer; border-bottom: 1px solid #dee2e6;';
                            div.innerHTML = `<strong>${item.name}</strong><br><small style="color: #6c757d;">${item.folder_path}</small>`;
                            div.addEventListener('click', () => {
                                if (item.is_folder) {
                                    window.location.href = `{{ url_for('browse', path='') }}${item.folder_path}`;
                                } else {
                                    window.location.href = `{{ url_for('view_node', node_id='') }}${item.id}`;
                                }
                            });
                            searchResults.appendChild(div);
                        });
                    }

                    const rect = searchInput.getBoundingClientRect();
                    searchResults.style.top = `${rect.bottom + window.scrollY}px`;
                    searchResults.style.left = `${rect.left + window.scrollX}px`;
                    searchResults.style.width = `${rect.width}px`;
                    searchResults.style.display = 'block';
                } catch (error) {
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<div style="padding: 10px;">Search error. Check console.</div>';
                    searchResults.style.display = 'block';
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!searchResults.contains(e.target) && e.target !== searchInput) {
                searchResults.style.display = 'none';
            }
        });
    </script>
</body>
</html>
