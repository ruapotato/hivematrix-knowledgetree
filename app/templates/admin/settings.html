<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Settings - KnowledgeTree</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">KnowledgeTree Admin Settings</h1>
            <div class="card__header-actions">
                <a href="{{ url_for('browse', path='') }}">
                    <button class="btn">
                        <span class="btn__label">
                            <i data-lucide="arrow-left" class="btn__icon"></i>
                            Back to Dashboard
                        </span>
                    </button>
                </a>
            </div>
        </div>
        <div class="card__body">
            <p>Welcome, <strong>{{ user.name }}</strong> ({{ user.permission_level }})</p>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Current Configuration</h2>
        </div>
        <div class="card__body">
            <table>
                <tbody>
                    <tr>
                        <td><strong>Neo4j URI:</strong></td>
                        <td>{{ settings.neo4j_uri }}</td>
                    </tr>
                    <tr>
                        <td><strong>Codex Service:</strong></td>
                        <td>{{ settings.codex_url }}</td>
                    </tr>
                    <tr>
                        <td><strong>Freshservice Domain:</strong></td>
                        <td>{{ settings.freshservice_domain }}</td>
                    </tr>
                    <tr>
                        <td><strong>Freshservice Status:</strong></td>
                        <td>
                            {% if settings.freshservice_configured %}
                                <span class="status-text status-text--success">âœ“ Configured</span>
                            {% else %}
                                <span class="status-text status-text--warning">Not configured</span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Sync Status</h2>
        </div>
        <div class="card__body">
            <div id="sync-status">Loading...</div>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Data Synchronization</h2>
        </div>
        <div class="card__body">
            <h3>Codex Sync</h3>
            <p>Synchronize company structure, users, and assets from Codex.</p>
            <button id="sync-codex-btn" class="btn btn--primary">
                <span class="btn__label">
                    <i data-lucide="database" class="btn__icon"></i>
                    Sync from Codex
                </span>
            </button>
            <div id="codex-sync-output" class="u-mt-2 u-hidden">
                <h4>Sync Output:</h4>
                <pre class="code-block"></pre>
            </div>

            <hr class="u-mt-4 u-mb-4">

            {% if settings.freshservice_configured %}
            <h3>Freshservice Ticket Sync</h3>
            <p>Synchronize support tickets from Freshservice.</p>
            <div class="u-flex u-flex-gap-2">
                <button id="sync-tickets-btn" class="btn btn--primary">
                    <span class="btn__label">
                        <i data-lucide="refresh-cw" class="btn__icon"></i>
                        Sync New Tickets
                    </span>
                </button>
                <button id="sync-tickets-overwrite-btn" class="btn">
                    <span class="btn__label">
                        <i data-lucide="refresh-ccw" class="btn__icon"></i>
                        Full Refresh (Overwrite)
                    </span>
                </button>
            </div>
            <div id="tickets-sync-output" class="u-mt-2 u-hidden">
                <h4>Sync Output:</h4>
                <pre class="code-block"></pre>
            </div>
            {% else %}
            <h3>Freshservice Ticket Sync</h3>
            <p class="status-text status-text--warning">Freshservice is not configured. Run <code>python init_db.py</code> to configure ticket syncing.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Export/Import User Data</h2>
        </div>
        <div class="card__body">
            <h3>Export User Data</h3>
            <p>Export all user-created (non-read-only) data to a JSON file. This can be used as a backup before wiping the database.</p>
            <button id="export-data-btn" class="btn btn--primary">
                <span class="btn__label">
                    <i data-lucide="download" class="btn__icon"></i>
                    Export User Data
                </span>
            </button>

            <hr class="u-mt-4 u-mb-4">

            <h3>Import User Data</h3>
            <p>Import data from a previously exported JSON file. This will merge the data into the current database.</p>
            <input type="file" id="import-file-input" accept=".json" class="u-mb-2">
            <button id="import-data-btn" class="btn btn--primary">
                <span class="btn__label">
                    <i data-lucide="upload" class="btn__icon"></i>
                    Import User Data
                </span>
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Dangerous Actions</h2>
        </div>
        <div class="card__body">
            <p class="status-text status-text--danger"><strong>Warning:</strong> This will delete all data in the KnowledgeTree database.</p>
            <button id="wipe-db-btn" class="btn btn--danger">
                <span class="btn__label">
                    <i data-lucide="alert-triangle" class="btn__icon"></i>
                    Wipe Database
                </span>
            </button>
        </div>
    </div>

    <script>
        // Load sync status
        async function loadSyncStatus() {
            try {
                const response = await fetch('{{ url_for("admin_sync_status") }}', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                document.getElementById('sync-status').innerHTML = `
                    <table>
                        <tbody>
                            <tr>
                                <td><strong>Synced Company Items:</strong></td>
                                <td>${data.company_items}</td>
                            </tr>
                            <tr>
                                <td><strong>Synced Tickets:</strong></td>
                                <td>${data.ticket_count}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('sync-status').innerHTML = '<p class="status-text status-text--danger">Failed to load sync status</p>';
            }
        }

        // Codex sync
        document.getElementById('sync-codex-btn').addEventListener('click', async () => {
            const btn = document.getElementById('sync-codex-btn');
            const output = document.getElementById('codex-sync-output');
            const pre = output.querySelector('pre');

            btn.disabled = true;
            btn.querySelector('.btn__label').innerHTML = '<i data-lucide="database" class="btn__icon"></i>Syncing...';
            lucide.createIcons();
            output.classList.remove('u-hidden');
            pre.textContent = 'Starting Codex sync...\n';

            try {
                const response = await fetch('{{ url_for("admin_sync_codex") }}', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.success) {
                    pre.textContent = data.output || 'Sync completed successfully!';
                    alert('Codex sync completed successfully!');
                    loadSyncStatus();
                } else {
                    pre.textContent = data.error || data.message;
                    alert('Codex sync failed. Check output for details.');
                }
            } catch (error) {
                pre.textContent = `Error: ${error.message}`;
                alert('Failed to run Codex sync');
            } finally {
                btn.disabled = false;
                btn.querySelector('.btn__label').innerHTML = '<i data-lucide="database" class="btn__icon"></i>Sync from Codex';
                lucide.createIcons();
            }
        });

        // Ticket sync (incremental)
        document.getElementById('sync-tickets-btn')?.addEventListener('click', async () => {
            const btn = document.getElementById('sync-tickets-btn');
            const output = document.getElementById('tickets-sync-output');
            const pre = output.querySelector('pre');

            btn.disabled = true;
            btn.querySelector('.btn__label').innerHTML = '<i data-lucide="refresh-cw" class="btn__icon"></i>Syncing...';
            lucide.createIcons();
            output.classList.remove('u-hidden');
            pre.textContent = 'Starting ticket sync...\n';

            try {
                const response = await fetch('{{ url_for("admin_sync_tickets") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ overwrite: false })
                });
                const data = await response.json();

                if (data.success) {
                    pre.textContent = data.output || 'Sync completed successfully!';
                    alert('Ticket sync completed successfully!');
                    loadSyncStatus();
                } else {
                    pre.textContent = data.error || data.message;
                    alert('Ticket sync failed. Check output for details.');
                }
            } catch (error) {
                pre.textContent = `Error: ${error.message}`;
                alert('Failed to run ticket sync');
            } finally {
                btn.disabled = false;
                btn.querySelector('.btn__label').innerHTML = '<i data-lucide="refresh-cw" class="btn__icon"></i>Sync New Tickets';
                lucide.createIcons();
            }
        });

        // Ticket sync (overwrite)
        document.getElementById('sync-tickets-overwrite-btn')?.addEventListener('click', async () => {
            if (!confirm('This will refresh ALL tickets. This may take a long time. Continue?')) {
                return;
            }

            const btn = document.getElementById('sync-tickets-overwrite-btn');
            const output = document.getElementById('tickets-sync-output');
            const pre = output.querySelector('pre');

            btn.disabled = true;
            btn.querySelector('.btn__label').innerHTML = '<i data-lucide="refresh-ccw" class="btn__icon"></i>Syncing...';
            lucide.createIcons();
            output.classList.remove('u-hidden');
            pre.textContent = 'Starting full ticket refresh...\n';

            try {
                const response = await fetch('{{ url_for("admin_sync_tickets") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ overwrite: true })
                });
                const data = await response.json();

                if (data.success) {
                    pre.textContent = data.output || 'Sync completed successfully!';
                    alert('Full ticket refresh completed successfully!');
                    loadSyncStatus();
                } else {
                    pre.textContent = data.error || data.message;
                    alert('Ticket sync failed. Check output for details.');
                }
            } catch (error) {
                pre.textContent = `Error: ${error.message}`;
                alert('Failed to run ticket sync');
            } finally {
                btn.disabled = false;
                btn.querySelector('.btn__label').innerHTML = '<i data-lucide="refresh-ccw" class="btn__icon"></i>Full Refresh (Overwrite)';
                lucide.createIcons();
            }
        });

        // Wipe database
        document.getElementById('wipe-db-btn').addEventListener('click', async () => {
            if (!confirm('Are you ABSOLUTELY SURE you want to wipe the entire database? This cannot be undone!')) {
                return;
            }
            if (!confirm('Last chance! Type YES in the next prompt to confirm.')) {
                return;
            }
            const confirmation = prompt('Type YES to confirm database wipe:');
            if (confirmation !== 'YES') {
                alert('Database wipe cancelled.');
                return;
            }

            try {
                const response = await fetch('{{ url_for("admin_wipe") }}', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.success) {
                    alert('Database wiped successfully!');
                    window.location.href = '{{ url_for("browse", path="") }}';
                } else {
                    alert('Failed to wipe database');
                }
            } catch (error) {
                alert('Error wiping database');
            }
        });

        // Export data
        document.getElementById('export-data-btn').addEventListener('click', async () => {
            window.location.href = '{{ url_for("admin_export") }}';
        });

        // Import data
        document.getElementById('import-data-btn').addEventListener('click', async () => {
            const file = document.getElementById('import-file-input').files[0];
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            const confirmation = confirm('Are you sure you want to import this data? This may overwrite existing user-created content.');
            if (!confirmation) {
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const btn = document.getElementById('import-data-btn');
            btn.disabled = true;
            btn.querySelector('.btn__label').innerHTML = '<i data-lucide="upload" class="btn__icon"></i>Importing...';
            lucide.createIcons();

            try {
                const response = await fetch('{{ url_for("admin_import") }}', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    alert('Import successful!');
                    window.location.reload();
                } else {
                    alert(`An error occurred: ${result.error}`);
                }
            } catch (error) {
                alert(`A network error occurred: ${error}`);
            } finally {
                btn.disabled = false;
                btn.querySelector('.btn__label').innerHTML = '<i data-lucide="upload" class="btn__icon"></i>Import User Data';
                lucide.createIcons();
            }
        });

        // Load status on page load
        loadSyncStatus();

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
