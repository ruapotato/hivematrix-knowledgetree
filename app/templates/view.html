<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Item - KnowledgeTree</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Dark mode support for ToastUI editor */
        [data-theme="dark"] .toastui-editor-defaultUI,
        [data-theme="dark"] .toastui-editor-toolbar,
        [data-theme="dark"] .toastui-editor-toolbar-icons,
        [data-theme="dark"] .toastui-editor-main-container,
        [data-theme="dark"] .toastui-editor-md-container,
        [data-theme="dark"] .toastui-editor-ww-container {
            background-color: var(--color-surface) !important;
            color: var(--color-text) !important;
        }

        [data-theme="dark"] .toastui-editor-contents {
            background-color: var(--color-surface) !important;
            color: var(--color-text) !important;
        }

        [data-theme="dark"] .toastui-editor-contents p,
        [data-theme="dark"] .toastui-editor-contents h1,
        [data-theme="dark"] .toastui-editor-contents h2,
        [data-theme="dark"] .toastui-editor-contents h3,
        [data-theme="dark"] .toastui-editor-contents h4,
        [data-theme="dark"] .toastui-editor-contents h5,
        [data-theme="dark"] .toastui-editor-contents h6,
        [data-theme="dark"] .toastui-editor-contents li,
        [data-theme="dark"] .toastui-editor-contents td,
        [data-theme="dark"] .toastui-editor-contents th {
            color: var(--color-text) !important;
        }

        [data-theme="dark"] .toastui-editor-md-splitter,
        [data-theme="dark"] .toastui-editor-toolbar-divider {
            background-color: var(--color-border-medium) !important;
        }

        [data-theme="dark"] .toastui-editor-mode-switch,
        [data-theme="dark"] .toastui-editor-toolbar-item-wrapper button {
            background-color: var(--color-surface) !important;
            color: var(--color-text) !important;
            border-color: var(--color-border-medium) !important;
        }

        [data-theme="dark"] .toastui-editor-toolbar-item-wrapper button:hover {
            background-color: var(--color-surface-hover) !important;
        }

        .editor-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <div class="header-toolbar header-toolbar--space-between">
                <a href="{{ url_for('browse', path=parent_path) }}">
                    <button class="btn">
                        <i data-lucide="arrow-left"></i>
                        <span class="btn__label">Back</span>
                    </button>
                </a>
                <h1 class="card__title u-m-0" id="node-name">Loading...</h1>
                <button id="export-context-btn" class="btn btn--primary">
                    <i data-lucide="download"></i>
                    <span class="btn__label">Export Context</span>
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <div class="header-toolbar header-toolbar--space-between">
                <h2 class="card__title">Content</h2>
                <button id="edit-btn" class="btn" style="display: none;">
                    <i data-lucide="edit"></i>
                    <span class="btn__label">Edit Content</span>
                </button>
            </div>
        </div>
        <div class="card__body">
            <div id="content-display"></div>

            <div id="editor-container" style="display: none;">
                <div id="editor"></div>
                <div class="editor-actions">
                    <button id="save-btn" class="btn btn--primary">
                        <i data-lucide="save"></i>
                        <span class="btn__label">Save Content</span>
                    </button>
                    <button id="cancel-edit-btn" class="btn">
                        <i data-lucide="x"></i>
                        <span class="btn__label">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Attachments</h2>
        </div>
        <div class="card__body">
            <div id="file-list"></div>
            <div class="u-mt-2">
                <input type="file" id="file-upload-input">
                <button id="upload-btn" class="btn">
                    <i data-lucide="upload"></i>
                    <span class="btn__label">Upload File</span>
                </button>
            </div>
        </div>
    </div>

    <div id="context-modal" class="modal">
        <div class="modal__dialog">
            <div class="modal__header">
                <h2 class="modal__title">Export Context</h2>
                <span id="close-modal-btn" class="modal__close">&times;</span>
            </div>
            <div class="modal__body">
                <p id="modal-message">Select the items to include in the exported context.</p>
                <div id="context-tree-container"></div>
                <textarea id="context-textarea" readonly class="form-group__input" style="display: none; height: 400px; font-family: monospace; resize: vertical;"></textarea>
            </div>
            <div class="modal__footer">
                <button id="generate-context-btn" class="btn btn--primary">
                    <i data-lucide="copy"></i>
                    <span class="btn__label">Generate & Copy Context</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script>
        const NODE_ID = "{{ node_id }}";
        let editor = null;

        async function loadNodeData() {
            try {
                const response = await fetch(`{{ url_for('get_node', node_id='') }}${NODE_ID}`, {
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    document.body.innerHTML = '<div class="card"><div class="card__body"><h1>Error: Not Found</h1><p>The requested item could not be found.</p></div></div>';
                    return;
                }
                const data = await response.json();

                document.getElementById('node-name').textContent = data.name;
                document.title = data.name;
                document.getElementById('content-display').innerHTML = data.content_html || '<p>No content yet. Edit to add some.</p>';

                // File list
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';
                if (data.files && data.files.length > 0) {
                    const ul = document.createElement('ul');
                    data.files.forEach(file => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = `{{ url_for('uploaded_file', filename='') }}${file.filename}`;
                        a.textContent = file.filename;
                        a.target = '_blank';
                        li.appendChild(a);
                        ul.appendChild(li);
                    });
                    fileList.appendChild(ul);
                } else {
                    fileList.innerHTML = '<p>No files attached.</p>';
                }

                // Editor setup (only if not read-only)
                const editorContainer = document.getElementById('editor-container');
                const contentDisplay = document.getElementById('content-display');
                const editBtn = document.getElementById('edit-btn');
                const cancelEditBtn = document.getElementById('cancel-edit-btn');

                if (!data.read_only) {
                    // Show edit button
                    editBtn.style.display = 'inline-flex';

                    // Initialize editor
                    editor = new toastui.Editor({
                        el: document.querySelector('#editor'),
                        height: '600px',
                        initialEditType: 'wysiwyg',
                        previewStyle: 'tab',
                        usageStatistics: false,
                        initialValue: data.content || ''
                    });

                    // Edit button click - show editor, hide content
                    editBtn.addEventListener('click', () => {
                        contentDisplay.style.display = 'none';
                        editorContainer.style.display = 'block';
                        editBtn.style.display = 'none';
                        lucide.createIcons(); // Reinitialize icons
                    });

                    // Cancel button click - hide editor, show content
                    cancelEditBtn.addEventListener('click', () => {
                        editorContainer.style.display = 'none';
                        contentDisplay.style.display = 'block';
                        editBtn.style.display = 'inline-flex';
                        // Reset editor content to original
                        editor.setMarkdown(data.content || '');
                        lucide.createIcons(); // Reinitialize icons
                    });

                    // Save button click
                    document.getElementById('save-btn').addEventListener('click', async () => {
                        await fetch(`{{ url_for('update_node', node_id='') }}${NODE_ID}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ content: editor.getMarkdown() })
                        });
                        alert('Content saved!');
                        const updatedData = await (await fetch(`{{ url_for('get_node', node_id='') }}${NODE_ID}`, {
                            credentials: 'same-origin'
                        })).json();
                        contentDisplay.innerHTML = updatedData.content_html;

                        // Switch back to view mode
                        editorContainer.style.display = 'none';
                        contentDisplay.style.display = 'block';
                        editBtn.style.display = 'inline-flex';
                        lucide.createIcons(); // Reinitialize icons
                    });
                }
            } catch (error) {
                console.error("Failed to load node data:", error);
                document.getElementById('node-name').textContent = "Error loading content.";
            }
        }

        // Context export
        document.getElementById('export-context-btn').addEventListener('click', async () => {
            const contextModal = document.getElementById('context-modal');
            const treeContainer = document.getElementById('context-tree-container');
            const contextTextarea = document.getElementById('context-textarea');
            const generateBtn = document.getElementById('generate-context-btn');

            treeContainer.innerHTML = 'Loading...';
            contextTextarea.style.display = 'none';
            treeContainer.style.display = 'block';
            generateBtn.style.display = 'block';
            contextModal.classList.add('active');

            const response = await fetch(`{{ url_for('get_context_tree', node_id='') }}${NODE_ID}`, {
                credentials: 'same-origin'
            });
            const data = await response.json();

            treeContainer.innerHTML = '';
            if (data.attached_folders.length === 0) {
                treeContainer.innerHTML = '<p>No attached folders in this context.</p>';
            } else {
                const ul = document.createElement('ul');
                ul.className = 'checkbox-list';

                data.attached_folders.forEach(folder => {
                    const li = document.createElement('li');
                    li.className = 'checkbox-list__item';

                    const label = document.createElement('label');
                    label.className = 'checkbox-list__label';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = true;
                    checkbox.dataset.id = folder.id;

                    label.appendChild(checkbox);
                    label.innerHTML += `📎 ${folder.name}`;
                    li.appendChild(label);
                    ul.appendChild(li);
                });

                treeContainer.appendChild(ul);
            }
        });

        document.getElementById('generate-context-btn').addEventListener('click', async () => {
            const treeContainer = document.getElementById('context-tree-container');
            const contextTextarea = document.getElementById('context-textarea');
            const modalMessage = document.getElementById('modal-message');
            const generateBtn = document.getElementById('generate-context-btn');

            const excludedIds = Array.from(treeContainer.querySelectorAll('input[type="checkbox"]:not(:checked)'))
                                     .map(cb => cb.dataset.id);

            const response = await fetch(`{{ url_for('get_context', node_id='') }}${NODE_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ excluded_ids: excludedIds })
            });
            const data = await response.json();

            treeContainer.style.display = 'none';
            generateBtn.style.display = 'none';
            contextTextarea.style.display = 'block';

            contextTextarea.value = data.context;
            contextTextarea.focus();
            contextTextarea.select();

            modalMessage.textContent = 'Auto-copied to clipboard! You can also copy the text below.';

            if (navigator.clipboard) {
                try {
                    await navigator.clipboard.writeText(data.context);
                } catch (err) {
                    console.error('Failed to auto-copy to clipboard:', err);
                    modalMessage.textContent = 'Could not auto-copy. Please copy the text manually.';
                }
            }
        });

        // Modal closing
        document.getElementById('close-modal-btn').addEventListener('click', () => {
            document.getElementById('context-modal').classList.remove('active');
        });

        window.addEventListener('click', (event) => {
            const modal = document.getElementById('context-modal');
            if (event.target == modal) {
                modal.classList.remove('active');
            }
        });

        // File upload
        document.getElementById('upload-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('file-upload-input');
            if (!fileInput || fileInput.files.length === 0) {
                alert('Please select a file to upload.');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const response = await fetch(`{{ url_for('upload_file_to_node', node_id='') }}${NODE_ID}`, {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });

            if (response.ok) {
                alert('File uploaded successfully!');
                fileInput.value = '';
                loadNodeData();
            } else {
                alert('File upload failed.');
            }
        });

        loadNodeData();

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
